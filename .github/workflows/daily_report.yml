name: Global Market Monitor Parallel

on:
  workflow_dispatch:
  schedule:
    - cron: '30 8 * * *'

jobs:
  global-market-analysis:
    name: ${{ matrix.market.name }} Analysis
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        market:
          - { id: 'tw-share', name: 'TW Taiwan' }
          - { id: 'us-share', name: 'US US' }
          - { id: 'hk-share', name: 'HK HK' }
          - { id: 'cn-share', name: 'CN China' }
          - { id: 'jp-share', name: 'JP Japan' }
          - { id: 'kr-share', name: 'KR Korea' }

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache Stock Data
        uses: actions/cache@v3
        with:
          path: data/${{ matrix.market.id }}/dayK
          key: stock-data-${{ matrix.market.id }}-${{ github.run_id }}
          restore-keys: |
            stock-data-${{ matrix.market.id }}-

      - name: Environment Setup
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests yfinance matplotlib tqdm akshare resend openai

      - name: Run Market Analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          REPORT_RECEIVER_EMAIL: ${{ secrets.REPORT_RECEIVER_EMAIL }}
        run: python main.py --market ${{ matrix.market.id }}

      - name: Post Cache Stock Data
        if: always()
        uses: actions/cache/save@v3
        with:
          path: data/${{ matrix.market.id }}/dayK
          key: stock-data-${{ matrix.market.id }}-${{ github.run_id }}
